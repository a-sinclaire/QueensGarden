#!/bin/bash
# Pre-commit hook: Update cache-busting and run checks

set -e  # Exit on error

echo "Running pre-commit checks..."

# Get the project root directory
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# 1. Update cache-busting to current commit hash
echo "Updating cache-busting..."
if [ -f "update-cache-bust.sh" ]; then
  bash update-cache-bust.sh
  # Stage the updated index.html
  git add index.html
else
  echo "Warning: update-cache-bust.sh not found, skipping cache-bust update"
fi

# 2. Check for syntax errors in JavaScript files
echo "Checking JavaScript syntax..."
JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.js$' || true)
if [ -n "$JS_FILES" ]; then
  for file in $JS_FILES; do
    if [ -f "$file" ]; then
      echo "  Checking $file..."
      # Use node to check syntax
      node -c "$file" || {
        echo "Error: Syntax error in $file"
        exit 1
      }
    fi
  done
fi

# 3. Check HTML syntax (basic validation)
echo "Checking HTML syntax..."
HTML_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.html$' || true)
if [ -n "$HTML_FILES" ]; then
  for file in $HTML_FILES; do
    if [ -f "$file" ]; then
      echo "  Checking $file..."
      # Basic check: ensure file is not empty and has basic HTML structure
      if ! grep -q "<!DOCTYPE html>" "$file" 2>/dev/null; then
        echo "Warning: $file may not be valid HTML (missing DOCTYPE)"
      fi
    fi
  done
fi

# 4. Documentation checks - warn about changes that might need documentation updates
echo ""
echo "Checking for documentation updates needed..."

DOC_WARNINGS=0

# Get list of changed files
CHANGED_FILES=$(git diff --cached --name-only)

# Check for game rules changes
if echo "$CHANGED_FILES" | grep -qE "(js/config/game-rules\.js|js/core/rules-engine\.js|js/core/game-engine\.js)"; then
  echo "  ‚ö†Ô∏è  Game rules/logic files modified!"
  echo "     ‚Üí Check if 'game rules' file needs updating"
  DOC_WARNINGS=$((DOC_WARNINGS + 1))
fi

# Check for control/input changes
if echo "$CHANGED_FILES" | grep -qE "(js/main\.js|index\.html)" && \
   git diff --cached | grep -qE "(addEventListener|keydown|keypress|keyup|touchstart|touchend|click|Arrow|WASD|controls)"; then
  echo "  ‚ö†Ô∏è  Input/control handling modified!"
  echo "     ‚Üí Check if CONTROLS.md needs updating"
  DOC_WARNINGS=$((DOC_WARNINGS + 1))
fi

# Check for UI/feature additions
if echo "$CHANGED_FILES" | grep -qE "(js/rendering/dom-renderer\.js|index\.html|css/)" && \
   git diff --cached | grep -qE "(class=|id=|data-|button|modal|hud|display|feature)"; then
  echo "  ‚ö†Ô∏è  UI elements or features modified!"
  echo "     ‚Üí Check if README.md 'How to Play' or feature descriptions need updating"
  DOC_WARNINGS=$((DOC_WARNINGS + 1))
fi

# Check for help modal content changes
if echo "$CHANGED_FILES" | grep -qE "(js/help-modal\.js|CONTROLS\.md|CREDITS\.md|game rules)"; then
  echo "  ‚ö†Ô∏è  Help modal content files modified!"
  echo "     ‚Üí Verify help modal displays correctly (test in browser)"
  DOC_WARNINGS=$((DOC_WARNINGS + 1))
fi

# Check for configuration changes
if echo "$CHANGED_FILES" | grep -qE "(js/config/.*\.js)"; then
  echo "  ‚ö†Ô∏è  Configuration files modified!"
  echo "     ‚Üí Check if README.md 'Development' or 'Configuration' sections need updating"
  DOC_WARNINGS=$((DOC_WARNINGS + 1))
fi

# Check for version.js changes (should always update changelog)
if echo "$CHANGED_FILES" | grep -q "js/config/version.js"; then
  echo ""
  echo "  ‚ö†Ô∏è  WARNING: You're committing changes to version.js"
  if ! echo "$CHANGED_FILES" | grep -q "CHANGELOG.md"; then
    echo "     ‚Üí CHANGELOG.md is NOT in this commit!"
    echo "     ‚Üí You MUST update CHANGELOG.md when bumping version numbers"
    DOC_WARNINGS=$((DOC_WARNINGS + 1))
  else
    echo "     ‚Üí Good! CHANGELOG.md is included in this commit"
  fi
  echo ""
fi

# Check for new files that might need documentation
NEW_FILES=$(git diff --cached --name-only --diff-filter=A | grep -E "\.(js|html|css)$" || true)
if [ -n "$NEW_FILES" ]; then
  echo "  ‚ö†Ô∏è  New files added:"
  echo "$NEW_FILES" | sed 's/^/     ‚Üí /'
  echo "     ‚Üí Consider updating README.md project structure if adding major components"
  DOC_WARNINGS=$((DOC_WARNINGS + 1))
fi

# Check for mobile-specific changes
if git diff --cached | grep -qE "(mobile|touch|@media|responsive|viewport)"; then
  echo "  ‚ö†Ô∏è  Mobile/responsive code modified!"
  echo "     ‚Üí Test on actual mobile device if possible"
  echo "     ‚Üí Check if README.md 'Browser Compatibility' or mobile features need updating"
  DOC_WARNINGS=$((DOC_WARNINGS + 1))
fi

# Summary
if [ $DOC_WARNINGS -gt 0 ]; then
  echo ""
  echo "üìù Documentation reminders: $DOC_WARNINGS potential update(s) needed"
  echo "   Please review the warnings above and update documentation as needed."
  echo ""
else
  echo "  ‚úì No obvious documentation updates needed"
fi

echo ""
echo "Pre-commit checks passed! ‚úì"
exit 0

